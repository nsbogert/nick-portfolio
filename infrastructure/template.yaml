AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Nick Bogert Portfolio - AI-powered portfolio website

Parameters:
  Environment:
    Type: String
    Default: prod
    AllowedValues: [prod]

Globals:
  Function:
    Timeout: 30
    Runtime: python3.13
    Architectures:
      - arm64

Resources:
  # ---- S3 Bucket (Static Site) ----
  SiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub nick-portfolio-site-${Environment}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  SiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudFrontOAC
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub ${SiteBucket.Arn}/*
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}

  # ---- CloudFront Distribution ----
  CloudFrontOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub nick-portfolio-oac-${Environment}
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        PriceClass: PriceClass_100
        HttpVersion: http2and3
        Comment: Nick Bogert Portfolio

        Origins:
          # S3 origin for static files
          - Id: S3Origin
            DomainName: !GetAtt SiteBucket.RegionalDomainName
            OriginAccessControlId: !Ref CloudFrontOAC
            S3OriginConfig:
              OriginAccessIdentity: ''

          # API Gateway origin
          - Id: ApiOrigin
            DomainName: !Sub ${ChatApi}.execute-api.${AWS::Region}.amazonaws.com
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2

        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # CachingOptimized
          Compress: true

        CacheBehaviors:
          - PathPattern: /api/*
            TargetOriginId: ApiOrigin
            ViewerProtocolPolicy: https-only
            AllowedMethods: [GET, HEAD, OPTIONS, PUT, PATCH, POST, DELETE]
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad  # CachingDisabled
            OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac  # AllViewerExceptHostHeader
            Compress: true

        # SPA fallback: serve index.html for 403/404
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 10
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 10

  # ---- API Gateway (HTTP API) ----
  ChatApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: $default
      CorsConfiguration:
        AllowOrigins:
          - '*'
        AllowMethods:
          - POST
          - OPTIONS
        AllowHeaders:
          - Content-Type
      RouteSettings:
        "POST /api/chat":
          ThrottlingBurstLimit: 10
          ThrottlingRateLimit: 5

  # ---- Lambda Function ----
  ChatFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub nick-portfolio-chat-${Environment}
      Handler: app.handler
      CodeUri: ../backend/chat/
      MemorySize: 256
      Environment:
        Variables:
          RATE_LIMIT_TABLE: !Ref RateLimitTable
          BEDROCK_MODEL: anthropic.claude-3-haiku-20240307-v1:0
          ALLOWED_ORIGIN: '*'
          KB_PATH: knowledge_base
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref RateLimitTable
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: !Sub arn:aws:bedrock:us-west-2::foundation-model/anthropic.claude-3-haiku-20240307-v1:0
      Events:
        ChatPost:
          Type: HttpApi
          Properties:
            ApiId: !Ref ChatApi
            Path: /api/chat
            Method: POST

  # ---- DynamoDB Table (Rate Limiting) ----
  RateLimitTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub nick-portfolio-rate-limits-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

Outputs:
  CloudFrontURL:
    Description: Portfolio website URL
    Value: !Sub https://${CloudFrontDistribution.DomainName}

  ApiEndpoint:
    Description: API Gateway endpoint
    Value: !Sub https://${ChatApi}.execute-api.${AWS::Region}.amazonaws.com

  SiteBucketName:
    Description: S3 bucket for static files
    Value: !Ref SiteBucket
